{"version":3,"file":"hotkeys.js","sources":["../undoManager/logs.js","../undoManager/initialize.js","../macro__actions.js","../editor__tools.js"],"sourcesContent":["// @ts-nocheck\r\nexport function redoLog(storage) {\r\n\r\n\tconsole.clear(); for (let state of storage.undo) console.log(state);\r\n\r\n\tdocument.querySelector('.log__redo').innerHTML = ''; for (let state of storage.redo) {\r\n\r\n\t\tlet logItem = document.createElement('p');\r\n\t\tlogItem.innerText = JSON.stringify(state);\r\n\t\tdocument.querySelector('.log__redo').appendChild(logItem);\r\n\r\n\t}\r\n\t\r\n}","// @ts-nocheck\r\n\r\nimport { redoLog } from \"./logs\";\r\n// var redoLog = (() => { });\r\n\r\nvar editor = document.getElementById('editor') || document.querySelector('textarea'),\t\r\n\tundoStorage = [],\r\n\tredoStorage = [],\r\n\tdebug = false;\r\n\r\nexport default function main(target, dbg) {\r\n\tdebug = dbg;\r\n\teditor = target;\r\n\treturn editor;\r\n}\r\n\r\neditor.addEventListener('keydown', function (event) {\r\n\r\n\t// console.log(event)\r\n\r\n\tinput.selection = {\r\n\t\tstart: event.target.selectionStart,\r\n\t\tend: event.target.selectionEnd,\r\n\t};\r\n\r\n\tif (input.selection_length) {\r\n\t\tinput.lostData = editor.value.slice(\r\n\t\t\tinput.selection.start,\r\n\t\t\tinput.selection.end\r\n\t\t)\r\n\t}\r\n\telse {\r\n\t\tinput.lostData = editor.value.slice(\r\n\t\t\tinput.selection.start - 1,\r\n\t\t\tinput.selection.end + 1\r\n\t\t)\r\n\t}\r\n\r\n});\r\neditor.addEventListener('paste', e => {\r\n\r\n\tinput.data = (window.clipboardData || e.clipboardData).getData('text/plain');\r\n\tinput.data = input.data.replace(/\\r\\n/g, '\\n');\r\n\t// если вызвано из контекстного меню, то выделение надо ловить в контекстном меню\r\n\r\n});\r\neditor.addEventListener('input', event => {\t\t\t// event.inputType && event.data\t\r\n\r\n\t// console.log(event)\r\n\r\n\tif (event.inputType == 'historyUndo') {\r\n\t\tconsole.log(event.inputType);\r\n\t\tevent.preventDefault();\t\t\t\t\t\t// prevent need on keypress\t\t\r\n\t\treturn false;\r\n\t}\r\n\r\n\r\n\tinput.type = event.inputType;\r\n\tif (input.type !== InputActionType.insertFromPaste) input.data = event.data;\r\n\r\n\tif (!input.selection_length) {\r\n\t\tif (input.type == InputActionType.deleteContentBackward) {\r\n\t\t\tinput.selection.start--;\r\n\t\t\tinput.selection.end--;\r\n\t\t\tinput.lostData = input.lostData[0];\r\n\t\t}\r\n\t\telse if (input.type == InputActionType.deleteContentForward) input.lostData = input.lostData[1];\r\n\t\telse if (input.type == InputActionType.insertText || input.type == InputActionType.insertFromPaste) {\r\n\r\n\t\t\tinput.lostData = input.lostData.slice(1, -1);\r\n\t\t}\r\n\t}\r\n\telse {\r\n\r\n\t\t// input.lostData = input.lostData.slice(1, -1); // !\r\n\t\tinput.selection.end = input.selection.start; // + ((input.data || {}).length || 0);\t\t\r\n\r\n\t}\r\n\r\n\t// action apply\r\n\t// InputTypeAction[event.inputType](event);\r\n\tundoStorage.push(Object.assign({}, input)); //  undoStorage.push(JSON.parse(JSON.stringify(input)))\r\n\r\n\t// clear redo action storage\r\n\tif (event.inputType != 'historyUndo') {\r\n\r\n\t\tredoStorage.splice(0, redoStorage.length);\r\n\t\tdebug && redoLog(storage);\r\n\t}\r\n\telse debug && redoLog(storage);\r\n});\r\n\r\n\r\nexport const input = {\r\n\r\n\ttype: null,\t\t// 'insertFromPaste' | 'deleteByCut' | 'insertText' | 'deleteContentBackward' | ...\r\n\tdata: null,\t\t//  inserted char by 'insertText' type\r\n\tlostData: null, //  data been selected on insert\r\n\r\n\tget selection_length() { return this.selection.end - this.selection.start },\r\n\tselection: {\r\n\t\tstart: null,\r\n\t\tend: null\r\n\t},\r\n}\r\n\r\n\r\n\r\nfunction actionApply(doingState, doingType) {\r\n\r\n\tif (Boolean(doingType) !== Boolean('redo')) var lostData = doingState.lostData, data = doingState.data;\r\n\telse {\r\n\t\tvar data = doingState.lostData,\r\n\t\t\tlostData = doingState.data;\r\n\t}\r\n\r\n\tswitch (doingState.type) {\r\n\t\tcase 'insertFromPaste':\r\n\r\n\t\t\teditor.value = (\r\n\t\t\t\teditor.value.substring(0, doingState.selection.start) + lostData +\r\n\t\t\t\teditor.value.substring(doingState.selection.start + data.length)\r\n\t\t\t);\r\n\t\t\teditor.setSelectionRange(doingState.selection.start, doingState.selection.end + lostData.length);\r\n\t\t\tif (doingState.caret) editor.selectionStart = editor.selectionEnd;\r\n\r\n\t\t\tbreak;\r\n\t\tcase 'insertText':\r\n\r\n\t\t\tif (!doingState.selection_length)\r\n\t\t\t\teditor.value = (\r\n\t\t\t\t\teditor.value.substring(0, doingState.selection.start) + (lostData || '') +\r\n\t\t\t\t\teditor.value.substring(doingState.selection.start + (data || '').length)  //  + !doingType\r\n\t\t\t\t);\r\n\r\n\t\t\teditor.setSelectionRange(\r\n\t\t\t\tdoingState.selection.start + lostData.length,\r\n\t\t\t\tdoingState.selection.end + lostData.length\t\t  // + lostData.length * !!doingType\r\n\t\t\t);\r\n\t\t\tbreak;\r\n\t\tcase 'deleteByCut': // either cut approach\r\n\t\tcase 'deleteContentForward': // del on sel.len == 0\r\n\t\tcase 'deleteContentBackward': // all other approaches to del\r\n\t\t\teditor.value = (\r\n\t\t\t\teditor.value.substring(0, doingState.selection.start) + (lostData || '') +\r\n\t\t\t\teditor.value.substring(doingState.selection.end + !!doingType * (data || '').length)\r\n\t\t\t);\r\n\r\n\t\t\teditor.selectionStart = editor.selectionEnd = (\r\n\t\t\t\tdoingState.selection.start +\r\n\t\t\t\t(\r\n\t\t\t\t\tdoingState.type == InputActionType.deleteContentBackward && (lostData || '').length == 1\r\n\t\t\t\t)\r\n\t\t\t);\r\n\r\n\t\t\tif ((lostData || '').length > 1) editor.selectionEnd = doingState.selection.start + lostData.length;\r\n\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nexport const storeMultiactions = function (event, callback, onfinish, kwargs) {\r\n\r\n\tevent.target.dispatchEvent(new KeyboardEvent('keydown'));\r\n\r\n\tlet postOptions = callback(event);\t\t \t\t\t\t\t\t\t// multiActions[event.key](event);\r\n\r\n\tlet transfer = new DataTransfer();\t\t\t\t\t\t\t// так для IE не будет работать\r\n\ttransfer.setData('text/plain',\r\n\t\tevent.target.value.slice(\r\n\t\t\t(kwargs || event.target).selectionStart, \r\n\t\t\tevent.target.selectionEnd  // or line.slice(1)\r\n\t\t)\r\n\t);\r\n\tlet clipboardEvent = new ClipboardEvent('paste', { clipboardData: transfer })\r\n\r\n\tevent.target.dispatchEvent(clipboardEvent);\r\n\tevent.target.dispatchEvent(new InputEvent('input', {\t\t\t// так для IE не будет работать \r\n\t\tdata: null,\r\n\t\tinputType: 'insertFromPaste'\r\n\t}));\r\n\tif (onfinish && postOptions && postOptions.backoffset !== undefined) onfinish(postOptions);\r\n}\r\n/**\r\n * \r\n * @param {*} event \r\n * @param {Function} callback \r\n * @param {startLine: Number, endLine: Number} kwargs - позиция начала строки и конца строки \r\n */\r\nexport const storeAction = function (event, callback, kwargs) {\r\n\r\n\t// if (!kwargs) kwargs = {\r\n\t// \t// todo default behavior (now is draft!!)\r\n\t// \tstartLine: editor.value.lastIndexOf('\\n', editor.selectionStart-1),\r\n\t// \tendLine: Math.max(editor.value.indexOf('\\n', editor.selectionEnd), editor.value.length)\r\n\t// }\r\n\r\n\tevent.target.selectionStart = kwargs.startLine + 1;\r\n\tevent.target.selectionEnd = kwargs.endLine;\t\r\n\r\n\tevent.target.dispatchEvent(new KeyboardEvent('keydown', {}));\r\n\tlet preformat = callback(event);\r\n\r\n\tlet transfer = new DataTransfer(); \t\t\t\t\t// так для IE не будет работать\r\n\ttransfer.setData('text/plain', event.target.value.substr(kwargs.startLine + 1, preformat.line.length));\r\n\tlet clipboardEvent = new ClipboardEvent('paste', { clipboardData: transfer })\r\n\r\n\tevent.target.dispatchEvent(clipboardEvent);\r\n\tinput.caret = 123;\r\n\tevent.target.dispatchEvent(new InputEvent('input', {\t// так для IE не будет работать \r\n\t\tdata: null,\r\n\t\tinputType: 'insertFromPaste'\r\n\t}));\r\n\tinput.caret = undefined;\r\n\r\n\treturn preformat;\r\n}\r\n\r\n\r\nconst InputActionType =\r\n{\r\n\tinsertFromPaste: 'insertFromPaste',\t\t\t\t\t// get selection (keydown) and clipboardData (paste)\r\n\tdeleteByCut: 'deleteByCut',\t\t\t\t\t\t\t// get selection (keydown) \r\n\tinsertText: 'insertText',\t\t\t\t\t\t\t// get data (input) and selection (keydown)\r\n\tdeleteContentBackward: 'deleteContentBackward',\t\t// get selection (keydown)\r\n\tdeleteContentForward: 'deleteContentForward'\t\t// get selection (keydown)\r\n}\r\n\r\nlet storage = { undo: undoStorage, redo: redoStorage };\r\nconst redo = (e) => {\r\n\tlet redoState = redoStorage.pop();\r\n\tif (redoState) {\r\n\t\tundoStorage.push(redoState), debug && redoLog(storage);\r\n\r\n\t\tactionApply(redoState, 'redo');\r\n\t\tif (e.preventDefault) e.preventDefault();\r\n\t}\r\n\r\n}\r\nexport const undo = (e) => {\r\n\tif (e.shiftKey) return redo(e);\r\n\r\n\tlet undoState = undoStorage.pop();\r\n\tif (undoState) {\r\n\t\tredoStorage.push(undoState), debug && redoLog(storage);\r\n\r\n\t\tactionApply(undoState, '');\r\n\t\tif (e.preventDefault) e.preventDefault();\r\n\t\t\r\n\t}\r\n}","// @ts-nocheck\r\n\r\n// import { input } from \"./undoManager/initialize\";\r\n\r\nexport const buffer = { paste: null };\r\nexport const finalPosition = Object.freeze({\r\n\tBegin: 0,\r\n\tpreBegin: 1,\r\n\tfillInside: 2,\r\n\tFill: 3,\r\n\tpreEnd: 4,\r\n\tEnd: 5,\t\r\n})\r\n\r\nexport var actionsMacro = {\r\n\r\n\ttag_in (value, line) { \r\n\t\tlet res = this.begin_end(['<'+value+'>', '</'+value+'>'], line); \r\n\t\tres.offset += res.offset + 1;\r\n\t\treturn res;\r\n\t},\r\n\r\n\t\r\n\tbegin_end:  (value, line) => {\r\n\r\n\t\tlet start = value[0],\r\n\t\t\tend = value[1];\t\t\r\n\t\tconst regex = new RegExp(start + '([\\\\s\\\\S]*?)' + end);\r\n\t\tconst undoFlag = line.match(regex);\r\n\r\n\t\treturn {\r\n\t\t\tline: undoFlag ? line.replace(regex, '$1') : start + line + end,\r\n\t\t\toffset: start.length,\r\n\t\t\tundo: undoFlag\r\n\t\t}\t\t\r\n\t},\r\n\tbegin: (value, line, event) => {\r\n\t\t// let value = '# '\r\n\t\t// const undoFlag = new RegExp('^' + value + '[\\\\s\\\\S]+?$').exec(line);\r\n\t\t// const undoFlag= line.match(/^# [\\S\\s]+?$/);\t// regex.exec(line);\r\n\t\t// const regex = new RegExp('^' + value + '([\\\\s\\\\S]+?)$').compile(); # err\r\n\r\n\t\tconst regex = new RegExp('^' + value + '([\\\\s\\\\S]+?)$');\r\n\t\tlet undoFlag = !event ? regex.exec(line) : event.shiftKey;\t\t\r\n\t\treturn {\r\n\t\t\t// line: undoFlag ? line.replace(/# ([\\s\\S]*?)/, '$1') : value + line,\r\n\t\t\tline: undoFlag ? line.replace(regex, '$1') : value + line,\r\n\t\t\toffset: value.length,\r\n\t\t\tundo: undoFlag,\r\n\t\t\teventAbort: true\r\n\t\t}\r\n\t},\t\t\t\r\n\t// get(){console.log(this)},\r\n}\r\n\r\n\r\nexport var multiMacro = {\r\n\r\n\r\n\tbegin: (value, e, target) => {\r\n\r\n\t\tlet start = target.selectionStart,\r\n\t\t\tend = target.selectionEnd;\r\n\r\n\t\tlet line = target.value.substring(start - 1, end);\r\n\t\tlet len = (line.split('\\n').length - 1) * value.length,\r\n\t\t\tundo = line.startsWith('\\n' + value);\r\n\r\n\t\t// @ts-ignore\r\n\t\tif (len === 0) format_text(e);\t\t\t\r\n\t\telse {\r\n\t\r\n\t\t\tlet startLine = target.value.substring(0, start - 1);\r\n\t\t\tline = !undo\r\n\t\t\t\t? line.replace(new RegExp('\\n', 'g'), '\\n' + value)\r\n\t\t\t\t: line.replace(new RegExp('\\n' + value, 'g'), '\\n');\r\n\t\r\n\t\t\ttarget.value = [startLine, line, target.value.substring(end)].join('');\r\n\t\r\n\t\t\t// target.setSelectionRange(start, end + len * (e.shiftKey ? -1 : 1));\r\n\t\t\ttarget.selectionStart = start;\r\n\t\t\ttarget.selectionEnd = end + len * (undo ? -1 : 1);\r\n\t\t}\r\n\t\te.preventDefault();\r\n\t},\r\n\tbegin_end: (value, e, target) => {\r\n\r\n\t\tlet start = target.selectionStart,\r\n\t\t\tend = target.selectionEnd;\r\n\t\tlet line = target.value.substring(start, end);\r\n\r\n\t\t// @ts-ignore\r\n\t\tif (line.split('\\n').length === 1) format_text(e); \t\t\t\t\t\t\t// todo ?\r\n\t\telse {\r\n\t\r\n\t\t\tlet startText = target.value.substring(0, start);\r\n\t\t\tline = value[0] + target.value.substring(start, end) + value[1];\r\n\t\t\tlet endText = target.value.substring(end);\r\n\t\t\ttarget.value = [startText, line, endText].join('');\r\n\t\r\n\t\t\ttarget.setSelectionRange(start, end + value[0].length + value[1].length);\r\n\t\t\t// target.selectionStart = start + value[0].length;\r\n\t\t\t// target.selectionStart = target.selectionEnd = end + value[0].length + value[1].length;\r\n\t\t}\r\n\t\te.preventDefault();\r\n\t\treturn { backoffset: undefined } // value[1].length\r\n\t},\r\n\tpaste_inline: (value, e, target, position, condition) => {\r\n\r\n\t\tlet start = target.selectionStart, end = target.selectionEnd;\r\n\t\tlet line = target.value.substring(start, end);\t\t\r\n\t\t\r\n\t\tif (line.indexOf('\\n') > 0) return;\r\n\t\telse{\r\n\t\t\tbuffer.paste = (event, _buff) => { if (!condition(_buff)) return;\r\n\t\t\t\t\r\n\t\t\t\tlet startText = target.value.substring(0, start);\r\n\t\t\t\tline = value.replace('%1', line).replace('$1', _buff)\t\t\t\t\r\n\t\t\t\tlet endText = target.value.substring(end);\r\n\t\t\t\ttarget.value = [startText, line, endText].join('');\t\r\n\t\t\t\ttarget.selectionEnd = (target.selectionStart = start) + line.length;\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tbuffer.paste = null;\r\n\r\n\t\t\t\tlet transfer = new DataTransfer(); \t\t\t    \t\t// так для IE не будет работать\r\n\t\t\t\ttransfer.setData('text/plain', line);\t\t\t\t\r\n\t\t\t\tevent.target.dispatchEvent(new ClipboardEvent('paste', { clipboardData: transfer }));\t\t\t\t\r\n\t\t\t\ttarget.dispatchEvent(new InputEvent('input', {\t\t\t// так для IE не будет работать \r\n\t\t\t\t\tdata: null,\r\n\t\t\t\t\tinputType: 'insertFromPaste'\r\n\t\t\t\t}));\r\n\r\n\t\t\t\tif (position === finalPosition.End) {\r\n\t\t\t\t\ttarget.selectionStart = target.selectionEnd = start + line.length;\r\n\t\t\t\t}\r\n\r\n\t\t\t}\t\t\r\n\t\t}\r\n\t\t// return { backoffset: 0 }\r\n\t}\r\n\r\n}","// @ts-nocheck\r\n\r\nimport { storeMultiactions, storeAction, undo } from \"./undoManager/initialize\";\r\nimport main from './undoManager/initialize';\r\nimport { actionsMacro, multiMacro, finalPosition, buffer } from \"./macro__actions\";\r\n\r\nvar editor = null,\r\n\tmultiActions = {},\r\n\tactions = {};\r\n\r\nexport default function initialize(target, keys, panel) {\r\n\r\n\tmain(editor = target || document.querySelector('textarea'));\r\n\tif (!(target instanceof HTMLTextAreaElement)) throw new Error('editor with hot keys needs textarea on the page');\r\n\r\n\teditor.addEventListener('keydown', preformat);\r\n\tif (keys instanceof Object) {\r\n\r\n\t\tif ('actions' in keys && keys.actions instanceof Object) {\r\n\t\t\tactions = keys.actions;\t\t\t\t\t// actions.__proto__ = actionsMacro;\t\t\t\r\n\t\t}\r\n\t\tif ('multiActions' in keys && keys.multiActions instanceof Object) {\r\n\t\t\tmultiActions = keys.multiActions;\t\t// multiActions.__proto__ = multiMacro;\t\t\r\n\t\t}\r\n\t}\r\n\r\n\tif (panel instanceof HTMLElement) panel = [].slice.apply(panel.querySelectorAll(`.${panel.className}>*`));\r\n\tif (Array.isArray(panel)) {\r\n\t\tpanel.forEach(btn => btn.addEventListener('click', format_text));\r\n\t}\r\n\r\n\teditor.addEventListener('paste', e => {\r\n\t\t\r\n\t\t// if (!e.isTrusted) return;\t\t\r\n\t\te.isTrusted && (buffer.paste || (() => { }))(e, e.clipboardData.getData('text/plain'));\r\n\t});\r\n\r\n\teditor.addEventListener('select', e => {\r\n\t\t// console.log(e)\t\t\r\n\t\t// if (editor.selectionStart+1 < editor.selectionEnd){\r\n\t\t// \tif (editor.value[editor.selectionEnd-1] === ' ') editor.selectionEnd--;\r\n\t\t// }\r\n\t})\r\n}\r\n\r\ninitialize.actionsMacro = actionsMacro;\r\ninitialize.multiMacro = multiMacro;\r\ninitialize.finalPosition = finalPosition;\r\n\r\n/**\r\n * в отличие от format_text(e)  \r\n * - триггерится только на текстареа (через нажатие горячих клавиш)\r\n * - обрабатывает случаи для таб\r\n * @param {*} event \r\n */\r\nfunction preformat(event) {\r\n\r\n\t// console.log(event);\r\n\tif (event.ctrlKey) event.code != 'KeyZ' ? format_text(event) : undo(event);\r\n\telse if (event.key.toLowerCase() === 'tab') {\r\n\r\n\t\t// определим, выделен ли текст\r\n\t\tlet start = event.target.selectionStart;\r\n\t\tlet end = event.target.selectionEnd;\r\n\t\tif (end - start > 0) {\r\n\r\n\t\t\tlet line = event.target.value.substring(start - 1, end);\r\n\t\t\tlet len = line.split('\\n').length - 1;\r\n\t\t\tif (len === 0) format_text(event);\r\n\t\t\telse {\r\n\r\n\t\t\t\tstoreMultiactions(event, () => {\r\n\r\n\t\t\t\t\tlet startLine = event.target.value.substring(0, start - 1)\r\n\t\t\t\t\tline = !event.shiftKey ? line.replace(/\\n/g, '\\n\t') : line.replace(/\\n\t/g, '\\n');\r\n\t\t\t\t\tlet endLine = event.target.value.substring(end);\r\n\t\t\t\t\tevent.target.value = [startLine, line, endLine].join('');\r\n\r\n\t\t\t\t\tevent.target.selectionStart = start;\r\n\t\t\t\t\tevent.target.selectionEnd = end + len * (event.shiftKey ? -1 : 1);\r\n\r\n\t\t\t\t})\r\n\r\n\t\t\t}\r\n\t\t\tevent.preventDefault();\r\n\t\t}\r\n\t\telse format_text(event);\r\n\t}\r\n}\r\n\r\n/**\r\n * форматирует выделенный фрагмент или строку, в которой находится каретка в текущий момент, \r\n * в соответствии с заданными правилами (actions и multiActions соответственно)\r\n * @param {*} event \r\n * @param {*} fake - эмуляция нажатого символа (опционально) для событий, не передающих нажатие клавиш (e.key)\r\n */\r\nfunction format_text(event, fake) {\r\n\r\n\tlet caret = null || 0;\r\n\tfake = fake || event.target.getAttribute('data-key')\r\n\r\n\t// получаем позицию курсора\r\n\tif (editor.selectionStart !== undefined) {\r\n\t\tif (editor.selectionStart < editor.selectionEnd) {\r\n\t\t\tif (editor.value.slice(editor.selectionStart, editor.selectionEnd).split('\\n').length > 1) {\r\n\t\t\t\tevent.key = event.key || event.target.getAttribute('data-key');\r\n\t\t\t\tif (multiActions[event.key] || multiActions[event.code]) {\t\t\t\t\t\r\n\r\n\t\t\t\t\treturn storeMultiactions(event,\r\n\t\t\t\t\t\t() => (multiActions[event.key] || multiActions[event.code])(event), // o => editor.selectionStart = editor.selectionEnd-=o.backoffset\t\t\t\t\t\t\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (event.code === 'KeyV'){ // спец категория экшенов в мультиэкшене - это работа с буфером\r\n\r\n\t\t\t\tif (multiActions[event.key] || multiActions[event.code]) {\r\n\r\n\t\t\t\t\teditor.selectionEnd-=editor.value[editor.selectionEnd-1] === ' ';\r\n\t\t\t\t\tevent.target.dispatchEvent(new KeyboardEvent('keydown'));\r\n\t\t\t\t\t(multiActions[event.key] || multiActions[event.code])(event);\r\n\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// else if(middlelineActions[event.key](event)) // todo\t\t\t\t\r\n\t\t\t// замена посреди строки (для ссылок и курсивного текста, например)\t\t\t\r\n\t\t}\r\n\t\tcaret = editor.selectionStart;\r\n\t}\r\n\telse alert('The browser not supports hot keys');\t\t\t\t// polyfill is required\r\n\r\n\r\n\t// получаем позицию начала строки\r\n\tlet startLine = (editor.value.lastIndexOf('\\n', caret - 1));\r\n\t// if (startLine < 0) startLine = 0;   \t\t\t\t\t\t\t// instead of +1 inside storeAction\r\n\r\n\t\r\n\t// получаем позицию конца строки\r\n\tlet endLine = (editor.value.indexOf('\\n', caret));\r\n\tif (endLine < 0) endLine = editor.value.length;\r\n\r\n\r\n\t// получаем текст:\r\n\tlet preLine = editor.value.substr(0, startLine ? startLine + 1 : startLine);\r\n\tlet line = editor.value.substring(startLine ? startLine + 1 : startLine, endLine);\r\n\tlet postLine = editor.value.substr(endLine);\r\n\r\n\t// actions.get(event && (event.key || (event.target.tagName.toLowerCase() === 'button' ? '/' : undefined)))\r\n\r\n\r\n\t// !todo undoMaager binding:\r\n\tvar formatAction = actions[event && (event.key || fake)];\r\n\tif (!event.key) event = { target: editor };\t\t\t\t\t\t // для кнопки нужно подменить target\r\n\tif (formatAction) {\r\n\r\n\t\tlet preformat = storeAction(event, () => {\r\n\t\t\tvar preformat = formatAction(line, event);\r\n\t\t\teditor.value = preLine + preformat.line + postLine;\r\n\t\t\treturn preformat;\r\n\t\t}, {\r\n\t\t\tstartLine: startLine, endLine: endLine\r\n\t\t})\r\n\r\n\t\tif (preformat.eventAbort) event.preventDefault();\r\n\t\t// возвращаем выделение\r\n\t\teditor.selectionStart = editor.selectionEnd = caret + preformat.offset * (preformat.undo ? -1 : 1);\r\n\r\n\t}\r\n\telse {\r\n\t\treturn;\r\n\t}\r\n\r\n\teditor.focus();\r\n\r\n}"],"names":["redoLog","storage","console","clear","undo","state","log","document","querySelector","innerHTML","redo","logItem","createElement","innerText","JSON","stringify","appendChild","editor","getElementById","undoStorage","redoStorage","debug","addEventListener","event","input","selection","start","target","selectionStart","end","selectionEnd","selection_length","lostData","value","slice","e","data","window","clipboardData","getData","replace","inputType","preventDefault","type","InputActionType","insertFromPaste","deleteContentBackward","deleteContentForward","insertText","push","Object","assign","splice","length","this","actionApply","doingState","doingType","Boolean","substring","setSelectionRange","caret","storeMultiactions","callback","onfinish","kwargs","dispatchEvent","KeyboardEvent","postOptions","transfer","DataTransfer","setData","clipboardEvent","ClipboardEvent","InputEvent","undefined","backoffset","storeAction","startLine","endLine","preformat","substr","line","deleteByCut","shiftKey","redoState","pop","undoState","buffer","paste","finalPosition","freeze","Begin","preBegin","fillInside","Fill","preEnd","End","multiMacro","begin","len","split","startsWith","format_text","RegExp","join","begin_end","startText","endText","paste_inline","position","condition","indexOf","_buff","multiActions","actions","initialize","keys","panel","dbg","HTMLTextAreaElement","Error","HTMLElement","apply","querySelectorAll","className","Array","isArray","forEach","btn","isTrusted","ctrlKey","code","key","toLowerCase","fake","getAttribute","alert","lastIndexOf","preLine","postLine","formatAction","eventAbort","offset","focus","actionsMacro","tag_in","res","regex","undoFlag","match","exec"],"mappings":"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"}